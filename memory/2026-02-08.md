# 2026-02-08 - Recovery and Model Switch

## Catastrophic Event Resolution
- Root cause: Missing `GEMINI_API_KEY` environment variable on Feb 6th
- This caused a gateway restart loop that wiped session logs
- Core files (MEMORY.md, SOUL.md, rules/, scripts/) remained intact

## Split-Brain Issue Fixed
- Cron jobs using `sessionTarget: isolated` with `agentTurn` were creating separate agent instances
- This caused "two versions of TARSON" talking to Regis simultaneously
- **Fix:** Changed all cron jobs to `sessionTarget: main` with `systemEvent`
- Jobs affected: Inbox Zero Fetch, Weekly Health Check, Memory Snapshot, Workspace Backup

## Model Hierarchy Changed
- **Before:** Gemini 2.5 Pro (primary) â†’ Claude (fallback)
- **After:** Claude Sonnet 4.5 (primary) â†’ Gemini (fallback)
- **Reason:** Gemini showed poor precision with tool usage (failed repeatedly to find `gog gmail batch delete`)

## Inbox Zero Status - RESOLVED
- Workflow tested successfully with inline buttons
- **Working command:** `GOG_KEYRING_PASSWORD=1234 gog gmail batch modify <ids> --account regis.depret@gmail.com --remove INBOX --force`
- `batch delete` fails with 403 insufficientPermissions (needs elevated scopes)
- `batch modify --remove INBOX` works perfectly - archives emails instead of deleting
- Keyring password: `1234`

## Interaction Patterns Documented
- Created `memory/interaction_patterns.md` for Inbox Zero button format
- Buttons use `message` tool with `buttons` parameter, NOT polls

## New Skill Installed
- `gmail` skill installed from ClawHub (requires MATON_API_KEY - not configured)

## iCloud Mail Integration
- **Email:** regis.depret@me.com
- **App-specific password:** ovay-iihc-mwgf-dnjf
- **IMAP server:** imap.mail.me.com:993
- **Script:** `scripts/icloud_inbox_fetch.sh`
- **Important:** Use `BODY.PEEK[]` instead of `RFC822` to avoid marking emails as read when fetching
- Combined fetch script now pulls from both Gmail and iCloud

## Cron Job Fix
- Changed Inbox Zero cron from `wakeMode: next-heartbeat` to `wakeMode: now`
- Jobs with `next-heartbeat` wait for scheduled heartbeat polling
- Jobs with `now` trigger immediately when due
- All jobs confirmed using `sessionTarget: main` (no split-brain)
- **Critical fix:** Added `heartbeat` config to `openclaw.json` â€” cron jobs with `sessionTarget: main` rely on heartbeat to deliver system events. Without heartbeat config, events queue but never fire.
- Heartbeat config: every 30m, target telegram, to 98960672

## Email Actions Clarified
- **Delete** = Move to trash (`--add TRASH` for Gmail, `+FLAGS \\Deleted` for IMAP)
- **Archive** = Remove from inbox (`--remove INBOX` for Gmail)

## IMAP UID Fix
- Bug: IMAP sequence IDs shift after deletion, causing wrong emails to be deleted
- Fix: Updated scripts to use stable UIDs instead of sequence numbers
- Scripts updated: `icloud_inbox_fetch.sh`, `icloud_action.sh`

## Tracking System Setup
- Created "Tracking" folder in iCloud for emails needing follow-up
- Gmail uses labels for same purpose
- Paul from Jobber onboarding email moved to Tracking (waiting to gather Jobber issues first)

## Inbox Zero UX Learnings
- Process emails one-by-one for rule contextualization (don't group during learning phase)
- Provide intelligent context/analysis, not just labels
- Every suggestion needs an actionable button
- For newsletters/reports: extract key takeaways so user gets value without reading
- Check for List-Unsubscribe header and offer one-click unsubscribe
- Grouping similar emails is for AFTER rules are established

## Coinbase Rule
- "Your recurring buy for" emails: IGNORE (handled by another robot)
- Alert if >4 pile up (robot may be stuck)
- Other Coinbase emails processed normally

## Dual Gateway Issue
- Two gateway processes caused cron failures
- Helper restarted cleanly - now single process running

## Cron Behavior Discovery
- Cron with `sessionTarget: main` uses heartbeat to deliver systemEvents
- **Critical:** If main session is "busy" (active conversation), heartbeat is skipped and retried later
- To test cron: stop chatting ~2-3 minutes before scheduled time (e.g., stop at :27 for :30 cron)
- Manual `cron wake` works when there's a gap in conversation

## Inbox Zero UX Rules Established
1. **Actionable buttons:** Every suggestion needs a button to act on it
2. **One-by-one during learning:** Process emails individually to build rules (don't group yet)
3. **Not resolved until confirmed:** "I'll handle it" â‰  resolved - track until confirmed
4. **Handle threads together:** Gmail thread_id groups messages - present as one item
5. **Archive over delete:** For trackable business items, prefer archive (history) over delete
6. **Offer "Solved (archive)":** For resolved trackable items, archive keeps history accessible

## Business Context Established
- **JMJ Immigration:** Handling family visa application - HIGH PRIORITY
- **Tucano Stones & Pavers:** Family business, switched to Jobber from QuickBooks
- **Websites managed by Regis:** pressurewashingatlanta.com, apluspowercleaning.com, tucanostones.com
- **Google Search Console alerts:** Track for website review, forward to appropriate Claude session

## Gmail Tracking Label
- Created "Tracking" label in Gmail (Label_81)
- Used for emails needing follow-up
- Parallel to iCloud "Tracking" folder

## Emails Processed This Session
- iCloud: ~15 emails processed (mostly deleted, some tracked)
- Gmail: 7 tracked (JMJ, Search Console alerts, Sales Order thread, EB3 thread)
- Gmail: 3 remaining (Search Console, Concrete residue, Chestnut)
- Coinbase recurring buys: 11 ignored (handled by other robot)

## Lesson Learned: External Reminders
- When a time-sensitive action is needed, CREATE an external reminder immediately
- Don't rely on "I'll mention it later" â€” that's ephemeral memory
- Use cron or calendar for anything time-bound
- Example failure: Saw system reminder about 3:30 PM cron test, didn't create alert for user

## Cron Behavior - Deep Dive
- `sessionTarget: main` + `wakeMode: now` needs the main lane to be IDLE
- If actively chatting, cron skips with "timeout waiting for main lane to become idle"
- Timeout is ~2 min, not configurable in config schema
- **Fix:** Changed Inbox Zero cron to `wakeMode: next-heartbeat` for reliability
- Trade-off: Less precise timing, but won't fight busy lane
- Workaround for testing: `openclaw cron run <id> --force` bypasses idle check
- **Irony:** Can't test cron from within chat because chatting = busy lane

## Google Tasks Auth Fixed
- Added `tasks` scope via `gog auth add regis.depret@gmail.com --services=gmail,calendar,tasks --force-consent`
- Now can create tasks programmatically
- Task lists available: Tars-Inbox, Tars-Infra, Tars-Work, Tars-Personal, TARSON-Orders

## Inbox Zero Rule Refinement
- **Track = Mark as Read + Remove from Inbox**
- When adding Tracking label, also: remove UNREAD, remove INBOX
- Email lives only in Tracking view until resolved
- Previously was keeping emails in both Inbox and Tracking (confusing)

## Bon Jovi Concert Tracked
- July 16, 2026 @ 7:30 PM, Madison Square Garden, NYC
- Section 226, Row 17, Seats 9-10
- Added to Google Calendar with reminders (1 week + 1 day before)
- Task created in Tars-Personal: "Plan NYC trip" due June 16 (1 month before)

## Inbox Zero Feature - Complete

### Workflow Established
1. Fetch emails from Gmail + iCloud
2. Present one-by-one with summary + inline buttons
3. On button click: execute action, delete message, present next
4. No confirmation messages between emails - keep flow smooth

### Technical Commands
- **Gmail track:** `gog gmail thread modify <thread_id> --add Label_81 --remove UNREAD --remove INBOX --force`
- **Gmail delete:** `gog gmail batch modify <id> --add TRASH --force`
- **Gmail archive:** `gog gmail thread modify <thread_id> --remove INBOX --force`
- **iCloud delete:** `bash scripts/icloud_action.sh delete <uid>`
- **Key learning:** Use `thread modify` not `batch modify` for threads with multiple messages

### Button Callback Format
- `inbox:delete:<gmail_id>`
- `inbox:track:<gmail_id>`
- `inbox:archive:<gmail_id>`
- `inbox:skip:<gmail_id>`
- `icloud:delete:<uid>`
- `icloud:track:<uid>`

### Data Extraction
- For HTML-only emails (like Xfinity), decode base64 and parse HTML for amounts/dates
- Extract: amount, due date, account number when available
- Never say "details not available" if extractable

### Tracking Label
- Gmail: Label_81 ("Tracking")
- iCloud: "Tracking" folder
- Track = Mark Read + Remove INBOX + Add Tracking label

### Rules Added Today
- Tax documents â†’ TRACK_FOR_ACCOUNTANT
- Serasa/SABESP â†’ FORWARD_TO_NATALINO_AND_TRACK (Brazil water bills, goal: 6 months clear)

### Google Tasks Integration
- Bills with due dates â†’ Create task in Tars-Personal with due date
- Work items â†’ Create task in Tars-Work
- Task lists: Tars-Inbox, Tars-Infra, Tars-Work, Tars-Personal, TARSON-Orders

## Tracking System Feature - Complete

### Design
- **Source of Truth:** Google Tasks (TARSON - Tracking list, ID: dDQyYU42X00zUzVRQm0zQw)
- **Awareness:** Heartbeat-integrated (every 30 min)
- **Notifications:** Always Telegram

### Urgency Levels
- ðŸ”´ **Critical** - Due today or past due â†’ Notify immediately
- ðŸŸ¡ **Soon** - Due within 3 days â†’ Notify once
- ðŸŸ¢ **Watching** - No due date â†’ Weekly digest

### Task Format
```
Title: [CATEGORY] Brief description
Due: date (if applicable)
Notes:
  Source: gmail:<thread_id> or icloud:uid:<uid>
  Category: bill|action|tax|work|website|watching|event
  Details: Additional context
  Last poke: YYYY-MM-DD
```

### Categories (learned from use)
- `[BILL]` - Payment due
- `[ACTION]` - User action needed
- `[TAX]` - Tax documents
- `[WORK]` - Work tasks
- `[WEBSITE]` - Website issues
- `[WATCHING]` - Monitoring, no specific action
- `[EVENT]` - Calendar events

### iCloud Email Linking
Since no web URL exists, use: `icloud:uid:<uid>`
Store subject in Details for reference

### Migrated Items (13)
- Bills: Xfinity, Sawnee EMC
- Action: JMJ EB3
- Tax: North Point, Tucano Stones
- Work: A Plus form, Chestnut, Sales Order, Search Console x2
- Watching: Serasa/Natalino, Jobber
- Event: Bon Jovi

## TODO: Inbox Zero Cron Investigation
- User reported Inbox Zero Fetch cron "didn't work as expected"
- Last status: "skipped" with error "empty-heartbeat-file"
- HEARTBEAT.md now exists with content - should work on next run
- Monitor next scheduled run and verify it triggers properly

## Serasa/SABESP Context (Brazil)
- **Situation:** Old water account from when Regis lived in SÃ£o Paulo
- **Moved out:** 2015, but name still on the bill
- **Current resident:** Natalino (homeowner)
- **Problem:** Natalino sometimes fails to pay â†’ Regis's name gets flagged by Serasa (credit bureau)
- **Process:** Forward these emails to Natalino, track until 6+ months without receiving them (meaning name removed)
- **Goal:** Get name removed from the SABESP account
- **Rule added:** `rules/inbox_zero.md` - FORWARD_TO_NATALINO_AND_TRACK

## Quote Workflow Discovery
- **Regis's role:** Responsible for quoting materials/products for Tucano jobs
- **Current flow:** Request quotes via iMessage â†’ Suppliers respond via email
- **Chestnut job:** GLM won the quote, email kept visible for logistics/execution
- **Active period:** ~20 more days (until ~Feb 28)
- **Future improvement idea:** BCC all suppliers on quote request emails
  - Benefit: All replies thread together for easier comparison/analysis
  - Recorded in `memory/tracking.md`
- **TARSON task:** Show attachments on quote emails + provide analysis/comparison
- **Note:** Google Tasks API missing OAuth scope - can't add tasks programmatically
